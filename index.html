<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


  <script src="scripts/vexflow-debug.js"></script>

  <script src="scripts/geof.js"></script>

  <script src="scripts/js-darwin.js"></script>
  <script src="scripts/dwn-criteria.js"></script>
  
  <script src="scripts/soundfont-player.min.js"></script>
  <script src="scripts/playback.js"></script>

  <style>

  svg {
  	width: 100%;
  }

  .form-inline {
  	background-color: #eee;
  	margin-bottom: 5px;
  }

  .form-inline > label {
  	margin-top: 5px;
  }

  .form-inline label {
   margin-right: 10px;
  }

  .form-inline input[type=text] { text-align:center }

  #row-add-crit, #row-remove-crit {
  	float: right;
  	margin-top: 8px;
  	margin-right: 5px;
  }

  .row-ident {
  	float: left;
  	margin-top: 10px !important;
  	margin-left:5px;
  }

  </style>

<script>


 $(document).ready(function(){

   // $("#boo").draggable();

    VF = Vex.Flow;

	// Create an SVG renderer and attach it to the DIV element named "boo".
	var div = document.getElementById("boo")
	var renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);

	// Configure the rendering context.
	renderer.resize(900, 200);
	var context = renderer.getContext();
	context.setFont("Arial", 10, "").setBackgroundFillStyle("#eed");
    context.scale(1, 1);

	// Create a stave of width 899 at position 10, 40 on the canvas.
	var stave = new VF.Stave(0, 40, 899);
    
	// Add a clef and time signature.
	stave.addClef("treble").addTimeSignature("4/4");

	// Connect it to the rendering context and draw!
	stave.setContext(context).draw();

    /////

    pop = new Population(10, 10, new Specimen(16, [60, 75]) );
    engine = new Engine(pop);

    link_GA_objects(engine);
    pop.specimens.map(function(s) { s.evaluate() });

    current = Gf.copy( pop.specimens[0] ); /// not necessarily the best one
    current.evaluate();

    redraw_music();

    var criterion_types = ['pitch', 'melodic', 'harmonic'];

	 $.each(criterion_types, function (k) {
	 	$('#crit_template #criterion_selector').append($('<option>', {
	 								value: criterion_types[k],
	 								text:  criterion_types[k]
	 							}));
	 	})


    $("#criteria").sortable();



    var crit_form_tmp = $("#crit_template").clone();

    crit_form_tmp.find("input, select").change( function() { console.log("change") } );

    criteria = [];

    crit_id_counter = 0;

    function num_crit () {
    	$("#criteria div".length())
    };

    function make_crit () {

    	crit_id_counter++;

    	var new_crit_form = crit_form_tmp.clone(true);
		new_crit_form.find(".row-ident").html(crit_id_counter);
		
		return new_crit_form;
    }

    // add functions to +/- buttons
	crit_form_tmp.find("#row-add-crit").click( function() {
 		$(this).closest("div").after( make_crit().show() );
    });

    crit_form_tmp.find("#row-remove-crit").click( function () {
    	$(this).closest("div").remove();
    });




	function newNote (keynum, dur) {

	 	var oct = Math.floor( keynum / 12) - 1;
	 	var pc = keynum % 12;

	 	var notestr = VF.integerToNote(pc) + "/" + oct;
	    
	 	var note = new VF.StaveNote({clef: "treble", keys: [ notestr ], duration: dur });

	    if ( [1, 3, 6, 8, 10].indexOf(pc) != -1) { /// is a black note (always sharp)
	    	note.addAccidental(0, new VF.Accidental("#"));
	    }

	 	return note;
 	}


 	function voice_from_specimen (spec, dur) {

 		var notes = spec.nucl.map( function(item) { return newNote( item, dur )} );

 		// Create a voice in 4/4 and add above notes
		var voice = new VF.Voice({num_beats: 4,  beat_value: 4});
		voice.addTickables(notes);

		// Format and justify the notes to 750 pixels
		var formatter = new VF.Formatter().joinVoices([voice]).format([voice], 750);

		return voice;
 	}

    
 	function redraw_music()
 	{
 		var voice = voice_from_specimen(current, "16");

 		var beams = VF.Beam.generateBeams(voice.tickables);

 		// erase SVG contents
		$("svg").empty();

		// draw elements
		stave.draw();
		voice.draw(context, stave);
		// draw the damned beams (? not part of voice)
		beams.forEach(function(beam) {
  			beam.setContext(context).draw();
		});

		$("#fitness_disp").text( current.evaluate().fitness.toFixed(3) );
 	}

 	$("#randomize").click( function () {

 		pop.randomize();
 		link_GA_objects(engine);
        pop.specimens.map(function(s) { s.evaluate() });
        
 		current = Gf.copy( pop.specimens[0] );
 		redraw_music();

	});

	$("#mutate").click( function () {
		current.mutate();
		redraw_music();

	});


	$("#iterate").click( function () {
		// should be a separate process?

		// test: set disply to random specimen
		// current = pop.specimens[ Gf.rrnd (0, pop.specimens.length - 1) ];

		engine.iterate();
		current = Gf.copy( pop.specimens[0] );
		redraw_music();

	});


	$("#play").click( function () {
		schedule(current.nucl);

	});

	$("#stop").click( function () {
		clearSchedule();

	});

    var num_criteria = 0;
    $("#criteria").append(make_crit().show());

    // the old button
	// $("#add-crit").click( add_crit );



	// convenient breakpoint for js console
    $("");

});

</script>
</head>

<body>
	<div class="container">
		<div class ="text-center">
	
			<h1>quick genetic algorithm</h1>
			<h3>with canned fitness function (all black notes)</h3>

			<div class="panel panel-default" id="boo"></div>
			<div class="btn-group">
				<div class="btn btn-primary" id="randomize">Randomize Population</div>
				<div class="btn btn-primary" id="mutate">Mutate Specimen</div>
				<div class="btn btn-primary" id="iterate">Iterate</div>
				<div class="btn btn-primary" id="play">Play</div>
				<div class="btn btn-primary" id="stop">Stop</div>
			</div>


			<h3>fitness:<div id="fitness_disp">_</div></h3>

			<h2>criteria <span style='color:lightgrey'>(they do nothing)</span></h2>
			
			<p><div class="btn btn-primary" id="add-crit" style="display:none">add criterion</div></p>
			<div id="criteria"></div>

			<h3>some buttons that don't do anything yet:</h3>

		<div class="btn-group btn-group-justified">
		  <a href="#" class="btn .btn-info">Export MusicXML</a>
		  <a href="#" class="btn .btn-info">Start GA</a>
		  <a href="#" class="btn .btn-info">Stop GA</a>
		</div>

	</div>

	<div id="crit_template" style="display:none">



		<form class="form-inline" action="javascript:void(0);" >

			<label class="row-ident">hello</label>

				<label for="criterion_selector"><select id="criterion_selector" class="form-control"></select></label>

				<label for="class">class <input id="class" type="checkbox"></input></label>
				<label for="signed">signed <input id="signed" type="checkbox"></input></label>

				<label for="value">value <input type="text" id="value"></input></label>
		
        <button type="button" class="btn btn-success btn-sm" id="row-add-crit">
            <span class="glyphicon glyphicon-plus"></span>
        </button> 

		<button type="button" class="btn btn-danger btn-sm" id="row-remove-crit">
            <span class="glyphicon glyphicon-minus"></span>
        </button>
   
		
        </form>

	</div>

</body>